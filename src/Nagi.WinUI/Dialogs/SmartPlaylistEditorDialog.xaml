<ContentDialog
    x:Class="Nagi.WinUI.Dialogs.SmartPlaylistEditorDialog"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:controls="using:ImageEx"
    xmlns:helpers="using:Nagi.Core.Helpers"
    xmlns:dialogs="using:Nagi.WinUI.Dialogs"
    xmlns:resources="using:Nagi.WinUI.Resources"
    mc:Ignorable="d"
    PrimaryButtonText="{x:Bind resources:Strings.SmartPlaylist_Dialog_PrimaryButton, Mode=OneTime}"
    CloseButtonText="{x:Bind resources:Strings.SmartPlaylist_Dialog_CloseButton, Mode=OneTime}"
    DefaultButton="Primary"
    PrimaryButtonClick="OnPrimaryButtonClick"
    Loaded="OnDialogLoaded"
    Style="{StaticResource DefaultContentDialogStyle}"
    FullSizeDesired="True">

    <ContentDialog.Resources>
        <!-- Override ContentDialog width constraints -->
        <x:Double x:Key="ContentDialogMinWidth">1100</x:Double>
        <x:Double x:Key="ContentDialogMaxWidth">1400</x:Double>
        
        <Style x:Key="RuleRowStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Margin" Value="0,4" />
        </Style>
    </ContentDialog.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" ColumnDefinitions="*" Margin="0,12,0,0">
        
        <!-- Row 0: General Info with Cover Image -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto, 24, *, 24, Auto" Margin="0,0,0,24">
            <!-- Cover Image Section -->
            <StackPanel Grid.Column="0" Spacing="8" VerticalAlignment="Top">
                <Grid x:Name="CoverImageGrid" Width="100" Height="100" 
                      Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" 
                      CornerRadius="12">
                    <FontIcon x:Name="CoverImagePlaceholder" Glyph="&#xE91B;" FontSize="40" 
                              HorizontalAlignment="Center" VerticalAlignment="Center"
                              Foreground="{ThemeResource TextFillColorSecondary}" />
                    <controls:ImageEx x:Name="CoverImagePreview" 
                                      Stretch="UniformToFill" 
                                      IsCacheEnabled="True"
                                      DecodePixelWidth="100"
                                      DecodePixelType="Logical"
                                      CornerRadius="12"
                                      Visibility="Collapsed" />
                </Grid>
                <Button x:Name="PickCoverImageButton"
                        Content="{x:Bind resources:Strings.SmartPlaylist_PickCoverButton_Content, Mode=OneTime}"
                        ToolTipService.ToolTip="{x:Bind resources:Strings.SmartPlaylist_PickCoverButton_ToolTip, Mode=OneTime}"
                        Click="PickCoverImage_Click"
                        HorizontalAlignment="Stretch" />
            </StackPanel>

            <!-- Name Section -->
            <StackPanel Grid.Column="2" Spacing="4" VerticalAlignment="Top">
                <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_PlaylistNameLabel, Mode=OneTime}" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                <TextBox x:Name="PlaylistNameTextBox"
                         PlaceholderText="{x:Bind resources:Strings.SmartPlaylist_PlaylistNameTextBox_Placeholder, Mode=OneTime}"
                         TextChanged="OnPlaylistNameChanged"
                         MaxLength="200" />
            </StackPanel>
            
            <!-- Sort Order Section -->
            <StackPanel Grid.Column="4" Spacing="4" MinWidth="200" VerticalAlignment="Top">
                <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_SortOrderLabel, Mode=OneTime}" Style="{ThemeResource BodyStrongTextBlockStyle}"/>
                <ComboBox x:Name="SortByComboBox" SelectedIndex="0" HorizontalAlignment="Stretch"
                          SelectionChanged="OnComboBoxSelectionChanged">
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.TitleAscLabel}" Tag="TitleAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.TitleDescLabel}" Tag="TitleDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.ArtistAscLabel}" Tag="ArtistAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.ArtistDescLabel}" Tag="ArtistDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.AlbumAscLabel}" Tag="AlbumAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.AlbumDescLabel}" Tag="AlbumDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.YearOldestLabel}" Tag="YearAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.YearNewestLabel}" Tag="YearDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.PlayCountAscLabel}" Tag="PlayCountAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.PlayCountDescLabel}" Tag="PlayCountDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.LastPlayedAscLabel}" Tag="LastPlayedAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.LastPlayedDescLabel}" Tag="LastPlayedDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.DateAddedAscLabel}" Tag="DateAddedAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.DateAddedDescLabel}" Tag="DateAddedDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.TrackNumberAscLabel}" Tag="TrackNumberAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.TrackNumberDescLabel}" Tag="TrackNumberDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.DurationAscLabel}" Tag="DurationAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.DurationDescLabel}" Tag="DurationDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.BpmAscLabel}" Tag="BpmAsc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.BpmDescLabel}" Tag="BpmDesc" />
                    <ComboBoxItem Content="{x:Bind helpers:SortOrderHelper.RandomLabel}" Tag="Random" />
                </ComboBox>
            </StackPanel>
        </Grid>

        <!-- Row 1: Rules Toolbar -->
        <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,12">
            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_MatchLabel, Mode=OneTime}" VerticalAlignment="Center"/>
                <ComboBox x:Name="MatchLogicComboBox" SelectedIndex="0" MinWidth="80"
                          SelectionChanged="OnComboBoxSelectionChanged">
                    <ComboBoxItem Content="{x:Bind resources:Strings.SmartPlaylist_MatchLogic_All_Content, Mode=OneTime}" Tag="All" />
                    <ComboBoxItem Content="{x:Bind resources:Strings.SmartPlaylist_MatchLogic_Any_Content, Mode=OneTime}" Tag="Any" />
                </ComboBox>
                <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_MatchSuffixLabel, Mode=OneTime}" VerticalAlignment="Center"/>
            </StackPanel>

            <Button Grid.Column="2" Click="AddRule_Click" ToolTipService.ToolTip="{x:Bind resources:Strings.SmartPlaylist_AddRuleButton_ToolTip, Mode=OneTime}" Style="{ThemeResource AccentButtonStyle}">
                <StackPanel Orientation="Horizontal" Spacing="6">
                    <FontIcon Glyph="&#xE710;" FontSize="12" />
                    <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_AddRuleLabel, Mode=OneTime}" />
                </StackPanel>
            </Button>
        </Grid>

        <!-- Row 2: Rules List & Empty State -->
        <Border Grid.Row="2" 
                BorderThickness="1" 
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" 
                CornerRadius="8" 
                Padding="0" 
                Background="{ThemeResource LayerFillColorDefaultBrush}">
            <Grid>
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="12">
                    <StackPanel Spacing="8">
                        <ListView x:Name="RulesListView"
                                  ItemsSource="{x:Bind Rules, Mode=OneWay}"
                                  SelectionMode="None"
                                  IsItemClickEnabled="False">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="ListViewItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0,0,0,8" />
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate x:DataType="dialogs:RuleViewModel">
                                    <Border Style="{StaticResource RuleRowStyle}">
                                        <Grid ColumnSpacing="12">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" MinWidth="180" />
                                                <ColumnDefinition Width="*" MinWidth="180" />
                                                <ColumnDefinition Width="*" MinWidth="200" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <ComboBox Grid.Column="0" 
                                                      ItemsSource="{x:Bind AvailableFieldsList}"
                                                      SelectedItem="{x:Bind SelectedField, Mode=TwoWay}"
                                                      DisplayMemberPath="DisplayName"
                                                      HorizontalAlignment="Stretch" />

                                            <ComboBox Grid.Column="1"
                                                      ItemsSource="{x:Bind AvailableOperators}"
                                                      SelectedItem="{x:Bind SelectedOperator, Mode=TwoWay}"
                                                      DisplayMemberPath="DisplayName"
                                                      HorizontalAlignment="Stretch" />

                                            <TextBox Grid.Column="2"
                                                     Text="{x:Bind Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                     PlaceholderText="{x:Bind resources:Strings.SmartPlaylist_RuleValueTextBox_Placeholder, Mode=OneTime}"
                                                     HorizontalAlignment="Stretch" />

                                            <Button Grid.Column="3"
                                                    Click="RemoveRule_Click"
                                                    ToolTipService.ToolTip="{x:Bind resources:Strings.SmartPlaylist_RemoveRuleButton_ToolTip, Mode=OneTime}"
                                                    Style="{ThemeResource SubtleButtonStyle}">
                                                <FontIcon Glyph="&#xE74D;" FontSize="14" Foreground="{ThemeResource SystemFillColorCriticalBrush}" />
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                        
                        <!-- Empty State -->
                        <StackPanel x:Name="NoRulesPanel"
                                   Visibility="Collapsed"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Spacing="16"
                                   Margin="0,48,0,48">
                            <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_NoRulesTitle, Mode=OneTime}"
                                       Style="{ThemeResource SubtitleTextBlockStyle}"
                                       HorizontalAlignment="Center"/>
                            <TextBlock Text="{x:Bind resources:Strings.SmartPlaylist_NoRulesMessage, Mode=OneTime}"
                                       Foreground="{ThemeResource TextFillColorSecondary}"
                                       HorizontalAlignment="Center"/>
                            <Button Content="{x:Bind resources:Strings.SmartPlaylist_AddFirstRuleButton_Content, Mode=OneTime}"
                                    ToolTipService.ToolTip="{x:Bind resources:Strings.SmartPlaylist_AddFirstRuleButton_ToolTip, Mode=OneTime}"
                                    Click="AddRule_Click"
                                    Style="{ThemeResource AccentButtonStyle}"
                                    HorizontalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Row 3: Footer Status -->
        <Border Grid.Row="3" Margin="0,16,0,0" Padding="12,8" 
                Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" 
                CornerRadius="4" 
                HorizontalAlignment="Stretch">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Left">
                <FontIcon Glyph="&#xE946;" FontSize="14" Foreground="{ThemeResource TextFillColorSecondary}" VerticalAlignment="Center"/>
                <TextBlock x:Name="MatchCountText" 
                           Foreground="{ThemeResource TextFillColorSecondary}" 
                           VerticalAlignment="Center"
                           Style="{ThemeResource CaptionTextBlockStyle}"/>
            </StackPanel>
        </Border>
    </Grid>
</ContentDialog>
