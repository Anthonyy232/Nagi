<Window
    x:Class="Nagi.WinUI.Popups.TrayPopup"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:Nagi.WinUI.ViewModels"
    xmlns:converters="using:Nagi.WinUI.Converters"
    xmlns:media="using:CommunityToolkit.WinUI.Media"
    xmlns:muxm="using:Microsoft.UI.Xaml.Media"
    xmlns:models="using:Nagi.Core.Models"
    mc:Ignorable="d">

    <Window.SystemBackdrop>
        <muxm:DesktopAcrylicBackdrop />
    </Window.SystemBackdrop>



    <Border x:Name="OuterBorder"
            BorderThickness="1"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            CornerRadius="8"
            d:DataContext="{d:DesignInstance Type=viewmodels:PlayerViewModel}">

        <Border.Resources>
        </Border.Resources>

        <Grid>
            <Border x:Name="CoverArtBackground"
                    CornerRadius="8">
                <Border.Background>
                    <media:ImageBlendBrush x:Name="CoverArtBrush"
                                           Mode="ColorBurn"
                                           Stretch="UniformToFill"
                                           Opacity="0.2" />
                </Border.Background>
            </Border>

            <Grid>
                <!-- Player View: Contains track info, seek bar, and media controls. -->
                <Grid Padding="16" RowSpacing="24"
                      Visibility="{Binding IsQueueViewVisible, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
                      Background="Transparent">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" HorizontalAlignment="Stretch" Spacing="2">
                        <TextBlock Style="{ThemeResource BodyStrongTextBlockStyle}"
                                   Text="{x:Bind ViewModel.SongTitle, Mode=OneWay, FallbackValue='A Really Long Song Title That Might Need to be Clipped'}"
                                   HorizontalAlignment="Center" TextAlignment="Center" TextTrimming="CharacterEllipsis"
                                   TextWrapping="NoWrap" />
                        <TextBlock Style="{ThemeResource BodyTextBlockStyle}"
                                   Text="{x:Bind ViewModel.ArtistName, Mode=OneWay, FallbackValue='An Artist With an Equally Long Name'}"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Center" TextAlignment="Center" TextTrimming="CharacterEllipsis"
                                   TextWrapping="NoWrap" />
                    </StackPanel>

                    <Slider x:Name="MediaSeekerSlider"
                            Grid.Row="1"
                            Maximum="{x:Bind ViewModel.TotalDuration, Mode=OneWay}" Value="{x:Bind ViewModel.CurrentPosition, Mode=TwoWay}"
                            ThumbToolTipValueConverter="{StaticResource TimeSpanToTimeStringConverter}"
                            IsThumbToolTipEnabled="True"
                            Style="{StaticResource MediaSeekerSliderStyle}"
                            PointerPressed="MediaSeekerSlider_PointerPressed"
                            PointerReleased="MediaSeekerSlider_PointerReleased"
                            PointerCaptureLost="MediaSeekerSlider_PointerCaptureLost"
                            KeyDown="MediaSeekerSlider_KeyDown"
                            KeyUp="MediaSeekerSlider_KeyUp" />

                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center" Spacing="8">
                        <Button Command="{x:Bind ViewModel.ToggleMuteCommand}" Style="{StaticResource VolumeButtonStyle}"
                                ToolTipService.ToolTip="{x:Bind ViewModel.VolumeButtonToolTip, Mode=OneWay}">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                      Glyph="{x:Bind ViewModel.VolumeIconGlyph, Mode=OneWay}" />
                        </Button>
                        <Button Command="{x:Bind ViewModel.ToggleShuffleCommand}" Style="{StaticResource ShuffleButtonStyle}"
                                ToolTipService.ToolTip="{x:Bind ViewModel.ShuffleButtonToolTip, Mode=OneWay}">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                      Glyph="{x:Bind ViewModel.ShuffleIconGlyph, Mode=OneWay}" />
                        </Button>
                        <Button Command="{x:Bind ViewModel.PreviousCommand}" Style="{StaticResource PreviousButtonStyle}"
                                ToolTipService.ToolTip="Previous">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}" Glyph="" />
                        </Button>
                        <Button Command="{x:Bind ViewModel.PlayPauseCommand}" Style="{StaticResource PlayPauseButtonStyle}"
                                ToolTipService.ToolTip="{x:Bind ViewModel.PlayPauseButtonToolTip, Mode=OneWay}">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}" FontSize="24"
                                      Glyph="{x:Bind ViewModel.PlayPauseIconGlyph, Mode=OneWay}" />
                        </Button>
                        <Button Command="{x:Bind ViewModel.NextCommand}" Style="{StaticResource NextButtonStyle}"
                                ToolTipService.ToolTip="Next">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}" Glyph="" />
                        </Button>
                        <Button Command="{x:Bind ViewModel.CycleRepeatCommand}" Style="{StaticResource RepeatButtonStyle}"
                                ToolTipService.ToolTip="{x:Bind ViewModel.RepeatButtonToolTip, Mode=OneWay}">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}"
                                      Glyph="{x:Bind ViewModel.RepeatIconGlyph, Mode=OneWay}" />
                        </Button>
                        <Button Command="{x:Bind ViewModel.ShowQueueViewCommand}" Style="{StaticResource QueueButtonStyle}"
                                ToolTipService.ToolTip="Up Next">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}" Glyph="" />
                        </Button>
                    </StackPanel>
                </Grid>

                <!-- Queue View: Displays the list of upcoming tracks. -->
                <Grid Padding="12,16,16,16"
                      Visibility="{Binding IsQueueViewVisible, Converter={StaticResource BooleanToVisibilityConverter}}"
                      Background="Transparent">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0">
                        <Button HorizontalAlignment="Left"
                                Command="{x:Bind ViewModel.ShowPlayerViewCommand}"
                                Style="{StaticResource MediaControlButtonStyle}"
                                ToolTipService.ToolTip="Back to Player">
                            <FontIcon FontFamily="{ThemeResource SymbolThemeFontFamily}" Glyph="" />
                        </Button>

                        <TextBlock VerticalAlignment="Center" HorizontalAlignment="Center"
                                   Style="{ThemeResource SubtitleTextBlockStyle}"
                                   Text="Up Next"
                                   Margin="12,0,12,4" />
                    </Grid>

                    <ListView Grid.Row="1"
                              ItemsSource="{x:Bind ViewModel.CurrentQueue, Mode=OneWay}"
                              SelectionMode="None"
                              ItemContainerStyle="{StaticResource QueueListViewItemStyle}"
                              VirtualizingStackPanel.VirtualizationMode="Recycling">
                        <ListView.ItemsPanel>
                            <ItemsPanelTemplate>
                                <ItemsStackPanel ItemsUpdatingScrollMode="KeepItemsInView" />
                            </ItemsPanelTemplate>
                        </ListView.ItemsPanel>
                        <ListView.ItemTemplate>
                            <DataTemplate x:DataType="models:Song">
                                <StackPanel Margin="0,4">
                                    <TextBlock
                                        Style="{ThemeResource BodyStrongTextBlockStyle}"
                                        Text="{x:Bind Title}"
                                        TextTrimming="CharacterEllipsis" />
                                    <TextBlock
                                        Style="{ThemeResource CaptionTextBlockStyle}"
                                        Text="{x:Bind ArtistName}"
                                        TextTrimming="CharacterEllipsis" />
                                </StackPanel>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </Grid>
        </Grid>
    </Border>
</Window>