<Page
    x:Class="Nagi.WinUI.Pages.LyricsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:core="using:Nagi.Core.Models.Lyrics"
    xmlns:converters="using:Nagi.WinUI.Converters"
    mc:Ignorable="d"
    Loaded="OnPageLoaded">

    <Page.Resources>
        <ResourceDictionary>
            <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
            <converters:ActiveLyricToStyleConverter
                x:Key="ActiveLyricToStyleConverter"
                ActiveStyle="{StaticResource ActiveLyricTextBlockStyle}"
                InactiveStyle="{StaticResource InactiveLyricLineStyle}" />
            <!-- IMPORTANT: This Storyboard is triggered in code-behind (LyricsPage.xaml.cs, OnPageLoaded) and must NOT be removed by cleanup tools. -->
            <Storyboard x:Key="PageLoadStoryboard">
                <DoubleAnimation
                    Storyboard.TargetName="LyricsContainer"
                    Storyboard.TargetProperty="Opacity"
                    From="0" To="1" Duration="0:0:0.5">
                    <DoubleAnimation.EasingFunction>
                        <ExponentialEase EasingMode="EaseOut" Exponent="3"/>
                    </DoubleAnimation.EasingFunction>
                </DoubleAnimation>
            </Storyboard>
        </ResourceDictionary>
    </Page.Resources>

    <Grid x:Name="LyricsContainer" Opacity="0">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <TextBlock
            Grid.Row="0"
            Margin="0,32,0,8"
            Style="{StaticResource TitleTextBlockStyle}"
            Text="{x:Bind ViewModel.SongTitle, Mode=OneWay}"
            FontWeight="SemiBold"
            HorizontalAlignment="Center"
            TextTrimming="CharacterEllipsis"
            MaxLines="1"
            MaxWidth="1200" />

        <ProgressBar
            x:Name="LyricsProgressBar"
            Grid.Row="1"
            Style="{StaticResource LyricsProgressBarStyle}"
            Margin="100,16,100,12"
            Visibility="{x:Bind ViewModel.ShowTimedLyrics, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}"
            MaxWidth="600" />

        <!-- Synchronized (timed) lyrics display -->
        <ListView
            x:Name="LyricsListView"
            Grid.Row="2"
            Padding="24,0,24,132"
            ItemsSource="{x:Bind ViewModel.LyricLines, Mode=OneWay}"
            Background="Transparent"
            SelectionMode="None"
            IsItemClickEnabled="True"
            ItemClick="LyricsListView_ItemClick"
            HorizontalContentAlignment="Stretch"
            ItemContainerStyle="{StaticResource LyricsListViewItemStyle}"
            Visibility="{x:Bind ViewModel.ShowTimedLyrics, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="core:LyricLine">
                    <TextBlock
                        Text="{x:Bind Text}"
                        Style="{x:Bind IsActive, Mode=OneWay, Converter={StaticResource ActiveLyricToStyleConverter}}"
                        Opacity="{x:Bind Opacity, Mode=OneWay}" />
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- Unsynchronized (plain text) lyrics display -->
        <ListView
            Grid.Row="2"
            Padding="24,0,24,132"
            ItemsSource="{x:Bind ViewModel.UnsyncedLyricLines, Mode=OneWay}"
            Background="Transparent"
            SelectionMode="None"
            IsItemClickEnabled="False"
            HorizontalContentAlignment="Stretch"
            ItemContainerStyle="{StaticResource LyricsListViewItemStyle}"
            Visibility="{x:Bind ViewModel.HasUnsyncedLyrics, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ListView.ItemTemplate>
                <DataTemplate x:DataType="x:String">
                    <TextBlock
                        Text="{x:Bind}"
                        Style="{StaticResource InactiveLyricLineStyle}"
                        Opacity="1.0" />
                </DataTemplate>
            </ListView.ItemTemplate>
        </ListView>

        <!-- No lyrics message -->
        <StackPanel
            Grid.Row="2"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Spacing="8"
            Visibility="{x:Bind ViewModel.ShowNoLyricsMessage, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel.ChildrenTransitions>
                <TransitionCollection>
                    <EntranceThemeTransition FromVerticalOffset="20" />
                </TransitionCollection>
            </StackPanel.ChildrenTransitions>
            <FontIcon
                Glyph="î¢²"
                FontSize="36"
                Margin="0,0,0,8"
                Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
            <TextBlock
                Style="{StaticResource SubtitleTextBlockStyle}"
                Text="No lyrics found for this track"
                HorizontalAlignment="Center" />
            <TextBlock
                Style="{StaticResource BodyTextBlockStyle}"
                Text="Try another song"
                HorizontalAlignment="Center"
                Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
        </StackPanel>

        <ProgressRing
            Grid.Row="2"
            Width="48"
            Height="48"
            IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
            HorizontalAlignment="Center"
            VerticalAlignment="Center" />
    </Grid>
</Page>